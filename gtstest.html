<!DOCTYPE HTML>
<html>
<head>
	<style type="text/css">
		html, body { height:100%; }
		body {width:900px; margin:0 auto; font-family:Helvetica;}
		h1, h3 { text-align:center; }
		p { line-height:130%;}
		pre { background:#eee; padding:1em; }
		.buttons { text-align:center; }
		button { font-size:150%; cursor:pointer; display:inline-block; margin:0.2em 0.5em;}
		button:disabled { cursor:auto; }
		.order { width:500px; margin:0 auto; padding:1em; border:1px solid #ccc; background:#eef; }
		.displayNone, #gts-order { display:none; }
		#my-gts-iframe { position:fixed; top:0; left:0; width:100%; background:#ccc; }
		#my-gts-iframe iframe { border:none; width:100%; }
		#anycommerce-gts-iframe { position:fixed; top:0; left:0; width:100%; border:none; }
	</style>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>

	<script>
		function gtsInit() {
			console.log(' ----- In gtsInit');
			
			var scheme = (("https:" == document.location.protocol) ? "https://" : "http://");
			var gts = document.createElement("script");
			gts.type = "text/javascript";
			gts.async = false;
			// If that's a first init - load script from Google
			if($('script[src*="www.googlecommerce.com/trustedstores/gtmp_compiled.js"]').attr("src")) {
				gts.src = scheme + window.document.location.hostname + "/resources/gtmp_compiled_WLWEGXvT1ic.js";
			} else {
				gts.src = scheme + "www.googlecommerce.com/trustedstores/gtmp_compiled.js";
			}
			var s = document.getElementsByTagName("script")[0];
			s.parentNode.insertBefore(gts, s);
		}
		
		function gtsDestroy() {
			// We need to destroy some GTS objects and nodes
			// Actually, it we could do 'delete.window.GoogleTrustedStore' that will be enough
			// but Google made 'window.GoogleTrustedStore' object indestroyable!!! (cyclic refs?)
			// Don't believe me? Try to delete it in FF/IE/Chrome :)
			// The only browser where we can delete it is Safari (Safari 5.1 in my case)
			console.log(' ----- In gtsDestroy');
			$('#gts-comm').remove(); // this is the hidden iframe GTS creates on init
			$('#gts-risk, #gts-c, #gts-g-w, #gts-bgvignette, .gtss-rc-sc-tc, .gtss-rc-sc, .gtss-uf').remove();
			$('span[tabindex="0"]').remove();
			$('.gtss-ed').parent().remove();
			$('script[src*="resources/gtmp_compiled"]').remove();
			$("script[id='validator.en']").remove();
			$("script[id='desktop.en']").remove();
			for (var i = 0; i < window.gts.length; i++) {
				if(window.gts[i][0] == "jsv" ) { window.gts.splice(i) }
			}
			// THE MOST IMPORTANT BIT - PUSH "jsv" = "WLWEGXvT1ic" to gts array
			window.gts.push(["jsv","WLWEGXvT1ic"]);
		}
		
		function gtsIFrame() {
			console.log(' ----- In gtsIFrame');
			
			vars = {
				"id":"",
				"google_base_offer_id":"",
				"google_base_subaccount_id":"",
				"google_base_country":"US",
				"google_base_language":"EN"
			};
			// fetch Google Trusted Stores vars from window.gts
			if(window.gts) {
				for (var i = 0; i < window.gts.length; i++) {
					vars[window.gts[i][0]] = window.gts[i][1];
				}
			}
			
			var gtsInitCode = 'var gts = gts || [];\
gts.push(["id", "'+vars["id"]+'"]);\
gts.push(["google_base_offer_id", "'+vars["google_base_offer_id"]+'"]);\
gts.push(["google_base_subaccount_id", "'+vars["google_base_subaccount_id"]+'"]);\
gts.push(["google_base_country", "'+vars["google_base_country"]+'"]);\
gts.push(["google_base_language", "'+vars["google_base_language"]+'"]);\
(function() {\
	var scheme = (("https:" == document.location.protocol) ? "https://" : "http://");\
	var gts = document.createElement("script");\
	gts.type = "text/javascript";\
	gts.async = false;\
	gts.src = scheme + "www.googlecommerce.com/trustedstores/gtmp_compiled.js";\
	var s = document.getElementsByTagName("script")[0];\
	s.parentNode.insertBefore(gts, s);\
})();\
';
			var frame = document.createElement("iframe");
			$(frame).attr("id","anycommerce-gts-iframe");
			
			if(!$("#anycommerce-gts-iframe").attr('id')) {
				$('body').append(frame);
			} else {
				frame = document.getElementByID("anycommerce-gts-iframe");
			}
			
			setTimeout(function(){
				var frameHead = frame.contentDocument.getElementsByTagName('head').item(0);
				var s = frame.contentDocument.createElement("script");
				s.type = "text/javascript";
				try {
					s.appendChild(document.createTextNode(gtsInitCode)); // doesn't work on ie...
				} catch(e) {
					s.text = gtsInitCode; // IE has funky script nodes
				}
				frame.contentWindow.document.body.appendChild(s);
			}, 250);
			
		}
		
		function gtsDestroyIFrame() {
			console.log(' ----- In gtsDestroyIFrame');
			$("#anycommerce-gts-iframe").remove();
		}
		
		var gts = gts || [];
		gts.push(["id", "12117"]);
		gts.push(["google_base_offer_id", "DPT5330A"]);
		gts.push(["google_base_subaccount_id", "1079369"]);
		gts.push(["google_base_country", "US"]);
		gts.push(["google_base_language", "EN"]);
		
		//gtsInit();
		
		$(document).ready(function(){
			//$("button#gtsInit").attr("disabled",false);
			$("button#gtsInit").click(function(){ gtsInit() });
			$("button#gtsDestroy").click(function(){ gtsDestroy() });
			$("button#gtsIFrame").click(function(){ gtsIFrame() });
			$("button#gtsDestroyIFrame").click(function(){ gtsDestroyIFrame() });
			$("button#gtsCreateOrder").click(function(){
				console.log(' ----- Creating gts-o structure');
				//$(this).attr("disabled",true);
				
				// make sure there's no #gts-order node in the DOM
				$("div#gts-order").remove();
				
				//gtsDestroy();
				
				// show Thank You note
				$(".order").fadeIn();

				// Insert gts-o data sections into DOM
				$div = $("<div \/>",{'id':'gts-order','style':'display:none;'});

				$("<span \/>",{'id':'gts-o-id'}).text('TEST111').appendTo($div);
				$("<span \/>",{'id':'gts-o-domain'}).text('tikimaster.com').appendTo($div); //sdomain
				$("<span \/>",{'id':'gts-o-email'}).text('mispeaced@gmail.com').appendTo($div);
				$("<span \/>",{'id':'gts-o-country'}).text('US').appendTo($div);
				$("<span \/>",{'id':'gts-o-total'}).text('13.90').appendTo($div);
				$("<span \/>",{'id':'gts-o-currency'}).text('USD').appendTo($div);
				$("<span \/>",{'id':'gts-o-discounts'}).text('0').appendTo($div);
				$("<span \/>",{'id':'gts-o-shipping-total'}).text('0').appendTo($div);
				$("<span \/>",{'id':'gts-o-tax-total'}).text('0').appendTo($div);
				$("<span \/>",{'id':'gts-o-est-ship-date'}).text('2013-07-20').appendTo($div); //!!! needs to be set.
				$("<span \/>",{'id':'gts-o-has-preorder'}).text('N').appendTo($div); //set in loop above.
				$("<span \/>",{'id':'gts-o-has-digital'}).text('N').appendTo($div);
				
				$itemSpan = $("<span \/>",{'class':'gts-item'});
				$("<span \/>",{'id':'gts-i-name'}).text('DPT5330A').appendTo($itemSpan);
				$("<span \/>",{'class':'gts-i-price'}).text('13.90').appendTo($itemSpan);
				$("<span \/>",{'class':'gts-i-quantity'}).text('1').appendTo($itemSpan);
				$("<span \/>",{'class':'gts-i-prodsearch-id'}).text('DPT5330A').appendTo($itemSpan);
				$("<span \/>",{'class':'gts-i-prodsearch-store-id'}).text('1079369').appendTo($itemSpan);
				$("<span \/>",{'class':'gts-i-prodsearch-country'}).text('US').appendTo($itemSpan);
				$("<span \/>",{'class':'gts-i-prodsearch-language'}).text('EN').appendTo($itemSpan);
				
				$itemSpan.appendTo($div);

				$div.appendTo('body');
				
				// re-init GTS code - it will think that we arrived at Order Confirmation step
				// will pick-up gts-order details block and send it to Google, hopefully 
				//gtsInit();
				
			});
			
			$('button#gtsFrameCreateOrder').click(function() {
				
				//gtsDestroy();
				
				// show Thank You note
				$(".order").fadeIn();
				
				var frame = document.createElement("iframe");
				$(frame).attr("id","anycommerce-gts-iframe");

				if(!$("#anycommerce-gts-iframe").attr('id')) {
					$('body').append(frame);
				} else {
					frame = document.getElementByID("anycommerce-gts-iframe");
				}

				setTimeout(function(){
					$div = $("<div \/>",{'id':'gts-order','style':'display:none;'});

					$("<span \/>",{'id':'gts-o-id'}).text('TEST111').appendTo($div);
					$("<span \/>",{'id':'gts-o-domain'}).text('tikimaster.com').appendTo($div); //sdomain
					$("<span \/>",{'id':'gts-o-email'}).text('mispeaced@gmail.com').appendTo($div);
					$("<span \/>",{'id':'gts-o-country'}).text('US').appendTo($div);
					$("<span \/>",{'id':'gts-o-total'}).text('13.90').appendTo($div);
					$("<span \/>",{'id':'gts-o-currency'}).text('USD').appendTo($div);
					$("<span \/>",{'id':'gts-o-discounts'}).text('0').appendTo($div);
					$("<span \/>",{'id':'gts-o-shipping-total'}).text('0').appendTo($div);
					$("<span \/>",{'id':'gts-o-tax-total'}).text('0').appendTo($div);
					$("<span \/>",{'id':'gts-o-est-ship-date'}).text('2013-07-20').appendTo($div); //!!! needs to be set.
					$("<span \/>",{'id':'gts-o-has-preorder'}).text('N').appendTo($div); //set in loop above.
					$("<span \/>",{'id':'gts-o-has-digital'}).text('N').appendTo($div);

					$itemSpan = $("<span \/>",{'class':'gts-item'});
					$("<span \/>",{'id':'gts-i-name'}).text('DPT5330A').appendTo($itemSpan);
					$("<span \/>",{'class':'gts-i-price'}).text('13.90').appendTo($itemSpan);
					$("<span \/>",{'class':'gts-i-quantity'}).text('1').appendTo($itemSpan);
					$("<span \/>",{'class':'gts-i-prodsearch-id'}).text('DPT5330A').appendTo($itemSpan);
					$("<span \/>",{'class':'gts-i-prodsearch-store-id'}).text('1079369').appendTo($itemSpan);
					$("<span \/>",{'class':'gts-i-prodsearch-country'}).text('US').appendTo($itemSpan);
					$("<span \/>",{'class':'gts-i-prodsearch-language'}).text('EN').appendTo($itemSpan);

					$itemSpan.appendTo($div);
					
					$div.appendTo($(frame.contentWindow.document.body));
				}, 250);
				
			}); // button#gtsFrameCreateOrder
		}); // $(document)
	</script>
	
</head>

<body>
	<h1>anyCommerce + Google Trusted Stores test page</h1>
	<h4>Basic idea how this should work:</h4>
	<p>
		 In the Rich Internet Application (RIA) HTML page loads only once. And HTML DOM initializes only once.<br />
		 After that any user interaction happens without the page reload - we just make ajax calls to send/fetch the data and then delete/insert html nodes into the existing DOM - using javascript.<br />
	   So, Google Trusted Stores badge code in RIA also initializes only once... But, unfortunately, that's not enough!
	</p>
	<p>
	   Imagine you're at the Product page (or at the Checkout page), preparing to complete the checkout. After you press "Create Test Order" button, we'll show "Thank You" note. Javascript will insert "gts-o" and "gts-i" data sections<br />
		<pre>
&lt;span id="gts-o-id">TEST111&lt;/span&gt;
&lt;span id="gts-o-domain">tikimaster.com&lt;/span&gt;
&lt;span id="gts-o-email">my_email_here&lt;/span&gt;
&lt;span id="gts-o-country">US&lt;/span&gt;
&lt;span id="gts-o-currency">USD&lt;/span&gt;
...</pre>
		into the existing DOM and we will need to destroy and re-load GTS javascript code by hand then. This page is created to perform such testing. See the page source for what we actually delete and how we re-init everything on checkout.
	</p>
		
	<div class="order displayNone">
		<h3>Order "TEST111" created. Thank you!</h3>
		<p>
			gts-order structure added to DOM, see Firebug->Inspect Element.<br />
			GTS code reloaded, hopefully Google received the test order data.<br /><br />
			Test this code in the <a href="https://www.google.com/trustedstores/sell">Google Trusted Stores panel</a><br />
			Also check the <a href="https://www.google.com/trustedstores/main#order/all/p/0">Google Trusted Stores orders list</a>
		</p>
	</div>
	
	<p class="buttons">
		<button id="gtsInit">Init GTS Code</button>
		<button id="gtsDestroy">Destroy GTS Code</button>
		<button id="gtsCreateOrder">Create Test Order</button><br />
		<button id="gtsIFrame">Init in iframe</button>
		<button id="gtsDestroyIFrame">Destroy in iframe</button>
		<button id="gtsFrameCreateOrder">Create order in iframe</button>
	</p>
	
</body>

</html>
